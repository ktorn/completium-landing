<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Completium RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Completium Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><title data-react-helmet="true">Multisig | Completium</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/templates/multisig"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Multisig | Completium"><meta data-react-helmet="true" name="description" content="This generic-purpose multi-signature contract is used to execute operations (transfer, contract entrypoints) that have been approved by a required number of managers."><meta data-react-helmet="true" property="og:description" content="This generic-purpose multi-signature contract is used to execute operations (transfer, contract entrypoints) that have been approved by a required number of managers."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/templates/multisig"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/templates/multisig" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/templates/multisig" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.d284df69.css">
<link rel="preload" href="/assets/js/runtime~main.db40fbb4.js" as="script">
<link rel="preload" href="/assets/js/main.8bf3c954.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div></a><a class="navbar__item navbar__link" href="/docs/dapp-first">First DApp</a><a class="navbar__item navbar__link" href="/dapps">DApps</a><a class="navbar__item navbar__link" href="/docs/contract">Smart Contract</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/templates">Contract Templates</a><a class="navbar__item navbar__link" href="/docs/verification">Formal Verification</a><a class="navbar__item navbar__link" href="/docs/cli">CLI</a><a class="navbar__item navbar__link" href="/docs/dapp-tools">Technical stack</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/edukera/completium-landing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/templates">Presentation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/docs/templates/fa12">Fungible Token</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/docs/templates/nft">Non-Fungible Token</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/docs/templates/zcb">DeFi</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/docs/templates/escrow">Payment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_2fq0" href="/docs/templates/multisig">Governance</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/templates/multisig">Multisig</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/raffle">Raffle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/ideabox">Idea box</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/competition">Competition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/auction">Auction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/a2">A 2</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Multisig</h1></header><p>This generic-purpose multi-signature contract is used to execute operations (transfer, contract entrypoints) that have been approved by a required number of managers.</p><p>The process is three steps:</p><ul><li><strong><em>propose</em></strong> : a manager proposes a list of operations to execute</li><li><strong><em>approve</em></strong> : managers may approve the proposal</li><li><strong><em>execute</em></strong> : operations may be executed (by anyone) when the required number of approvals has been reached</li></ul><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>The source code and unitary tests are available in this <a href="https://github.com/completium/archetype-multisig" target="_blank" rel="noopener noreferrer">repository</a>.</p></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="propose">Propose<a aria-hidden="true" class="hash-link" href="#propose" title="Direct link to heading">â€‹</a></h2><p>A proposal is made of a list of operations materialised as a lambda value of type <code>lambda unit (list operation)</code>, that is a function with no argument that returns a list of operations.</p><p>A lambda value is an anonymous function that can be stored, passed as an argument to a function or an entry point, and executed programmatically.</p><p>Passing a lambda value rather than a list of operations is necessary because, in Michleson, there is no literal for operations (for security reason); operations are only obtained with the <em>transfer</em> instruction.</p><p>A proposal also has a <em>validity</em> duration; it cannot be executed beyond the expiration date, which is the date of proposal plus the validity duration.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="calling-one-entrypoint">Calling one entrypoint<a aria-hidden="true" class="hash-link" href="#calling-one-entrypoint" title="Direct link to heading">â€‹</a></h3><p>The lambda value that returns the list of one operation which calls an entrypoint of a contract is presented here:</p><div class="codeBlockContainer_K1bP language-bash"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  DROP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                                    </span><span class="token comment" style="color:rgb(98, 114, 164)"># drops the Unit argument</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  NIL operation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                           </span><span class="token comment" style="color:rgb(98, 114, 164)"># stacks the empty operation list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  PUSH address </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token string variable" style="color:rgb(255, 121, 198)">${contract_address}</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># stacks the contract address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  CONTRACT %</span><span class="token variable">${entrypoint_name}</span><span class="token plain"> </span><span class="token variable">${type}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># creates an option of contract&#x27;s entrypoint (from address)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  IF_NONE                                  </span><span class="token comment" style="color:rgb(98, 114, 164)"># if contract address or entry not found</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> PUSH string </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;EntryNotFound&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">         </span><span class="token comment" style="color:rgb(98, 114, 164)"># stacks error message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      FAILWITH </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">                           </span><span class="token comment" style="color:rgb(98, 114, 164)"># fails</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  PUSH mutez </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                            </span><span class="token comment" style="color:rgb(98, 114, 164)"># stacks number of tez to send contract</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  PUSH </span><span class="token variable">${type}</span><span class="token plain"> </span><span class="token variable">${value}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                   </span><span class="token comment" style="color:rgb(98, 114, 164)"># stacks entrypoint argument</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  TRANSFER_TOKENS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                         </span><span class="token comment" style="color:rgb(98, 114, 164)"># generates operation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  CONS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                                    </span><span class="token comment" style="color:rgb(98, 114, 164)"># adds it to the empty operation list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>where:</p><ul><li><code>contract_address</code> is the address of the contract to call</li><li><code>entrypoint_name</code> is the name of the entrypoint to execute</li><li><code>type</code> is the type of the argument</li><li><code>value</code> is the value to pass to the entrypoint</li></ul><p>NB : these values must be set in the lambda value.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="michelson-types-and-values">Michelson types and values<a aria-hidden="true" class="hash-link" href="#michelson-types-and-values" title="Direct link to heading">â€‹</a></h3><p>The table below presents the Michelson syntax for the main types and corresponding value examples to pass to the entrypoint, as well as the Archetype types:</p><table><thead><tr><th>Archetype type</th><th>Michelson type</th><th>Michelson value example</th></tr></thead><tbody><tr><td><code>bool</code></td><td><code>bool</code></td><td><code>True</code>, <code>False</code></td></tr><tr><td><code>nat</code></td><td><code>nat</code></td><td><code>2022</code></td></tr><tr><td><code>int</code></td><td><code>int</code></td><td><code>-42</code></td></tr><tr><td><code>string</code></td><td><code>string</code></td><td><code>&quot;Hello multisig&quot;</code></td></tr><tr><td><code>address</code></td><td><code>address</code></td><td><code>&quot;tz1hyc1CRQpjskJUUaGrh85UZXPi6kU4JuGd&quot;</code></td></tr><tr><td><code>bytes</code></td><td><code>bytes</code></td><td><code>0x000001</code></td></tr><tr><td><code>option&lt;TYPE&gt;</code></td><td><code>option TYPE</code></td><td>example of <code>option nat</code>: <code>None</code>, <code>Some 42</code></td></tr><tr><td><code>list&lt;TYPE&gt;</code></td><td><code>list TYPE</code></td><td>example of <code>list nat</code>: <code>{ 42; 5567; 756786 }</code></td></tr><tr><td><code>(TYPE1 * TYPE2)</code></td><td><code>pair TYPE1 TYPE2</code></td><td>example of <code>pair nat string</code>: <code>Pair 45 &quot;Hello&quot;</code></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_31ik" id="state-machine">State Machine<a aria-hidden="true" class="hash-link" href="#state-machine" title="Direct link to heading">â€‹</a></h2><p>The contract has 3 states :</p><table><thead><tr><th>State</th><th>Description</th></tr></thead><tbody><tr><td>Starting</td><td>Initial state. The declared owner sets the parameters of the contract (add/remove manager, number of required approval, ...). No proposal can be submitted.</td></tr><tr><td>Running</td><td>Contract ownership is transferred to the contract itself (<code>owner = selfaddress</code>). The Propose/approve/execute process is operational.</td></tr><tr><td>Paused</td><td>No proposal can be submitted.</td></tr></tbody></table><blockquote><p>Note that in <code>Running</code> state, the owner of the contract is the contract itself. This implies that changes in the contract parameters must follow the propose/approve/execute process (including pausing the contract).</p></blockquote><h3 class="anchor anchorWithStickyNavbar_31ik" id="transitions">Transitions<a aria-hidden="true" class="hash-link" href="#transitions" title="Direct link to heading">â€‹</a></h3><p>The table below presents the entrypoints to go from one state to another</p><table><thead><tr><th>From</th><th>To</th><th>entrypoint</th></tr></thead><tbody><tr><td>Starting</td><td>Running</td><td><code>run</code></td></tr><tr><td>Running</td><td>Paused</td><td><code>pause</code></td></tr><tr><td>Paused</td><td>Running</td><td><code>unpause</code></td></tr></tbody></table><blockquote><p>Note that the <code>unpause</code> mechanism uses its own approval mechanism: the required number of manager needs to call entrypoint <code>approve_unpause</code> for the <code>unpause</code> entrypoint to be executable.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_31ik" id="number-of-required-managers">Number of required managers<a aria-hidden="true" class="hash-link" href="#number-of-required-managers" title="Direct link to heading">â€‹</a></h2><p>The best practice to setup the multisig process is that the maximum value for the <code>required</code> data (number of required managers to execute the operations) is the <em>number of registered managers minus 1</em>.</p><p>This rule is coded in the contract in the execution condition <code>r7</code> of the <code>require</code> entrypoint:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry %require(new_required : nat) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by owner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r7 : 0 &lt; new_required &lt; manager.count()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required := new_required</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is for security reason: if one of the manager&#x27;s private key is compromised, it is necessary to have one extra manager to vote for the removal of the compromised manager.</p><p>The extra manager may typically be the initial owner of the contract.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="feeless">Feeless<a aria-hidden="true" class="hash-link" href="#feeless" title="Direct link to heading">â€‹</a></h2><p>The contract provides with (one step) feeless process for proposal and approval, respectively with the entrypoints <code>propose_feeless</code> and <code>approve_feeless</code>.</p><p>The feeless approach splits the process in two:</p><ul><li>the manager signs the required data to propose or approve</li><li>an &quot;injector&quot; can then call the feeless entries with the signed data</li></ul><p> The benefit is that managers do not pay the blockchain fee. Hence managers are not required to have tez, nor to have a revealed address on the blockchain; they are just required to be able to sign with a wallet.</p><p> The injector is the one paying the fee to the blockchain. It is typically a backend process.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="data-to-sign">Data to sign<a aria-hidden="true" class="hash-link" href="#data-to-sign" title="Direct link to heading">â€‹</a></h3><p> The table below presents the data to sign for each feeless entrypoint:</p><table><thead><tr><th>Entrypoint</th><th>Michelson data type</th><th>Michelson value</th></tr></thead><tbody><tr><td><code>propose_feeless</code></td><td><code>pair address (pair nat (pair string (pair (lambda unit (list operation)) nat)))</code></td><td>Tuple of:<ul><li>manager address (public key hash)</li><li>manager counter</li><li><code>&quot;propose&quot;</code></li><li>lambda value</li><li>validity duration (before expiration)</li></ul></td></tr><tr><td><code>approve_feeless</code></td><td><code>pair address (pair nat (pair string nat))</code></td><td>Tuple of: <ul><li>manager address (public key hash)</li><li>manager counter</li><li><code>&quot;approve&quot;</code></li><li>validity duration (before expiration)</li></ul></td></tr></tbody></table><p> Each manager is associated to a counter that is incremented by the contract each time a feeless entry is called. This is a security feature to prevent from replay attack (so that one cannot use the signed data twice).</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="storage">Storage<a aria-hidden="true" class="hash-link" href="#storage" title="Direct link to heading">â€‹</a></h2><table><thead><tr><th>Element</th><th>Michelson type</th><th>Desc.</th></tr></thead><tbody><tr><td><code>owner</code></td><td><code>address</code></td><td>Contract&#x27;s owner address.</td></tr><tr><td><code>required</code></td><td><code>nat</code></td><td>Minimum number of approvals to execute operations.</td></tr><tr><td><code>min_duration</code></td><td><code>nat</code></td><td>Minimum validity duration of a proposal.</td></tr><tr><td><code>max_duration</code></td><td><code>nat</code></td><td>Maximum validity duration of a proposal.</td></tr><tr><td><code>id_count</code></td><td><code>nat</code></td><td>Id of next proposal.</td></tr><tr><td><code>manager</code></td><td><code>map address nat</code></td><td>Map of managers; a manager is associated to a counter (security data for feeless process).</td></tr><tr><td><code>proposal</code></td><td><code>map nat (pair nat (pair (set address) (lambda Unit (list operation))))</code></td><td>Map of proposals; a proposal is associated to: <ul><li>expiration date</li><li>set of approvers</li><li>list of operations (as a lambda)</li></ul></td></tr><tr><td><code>owner_candidate</code></td><td><code>option address</code></td><td>Optional address of owner candidate.</td></tr><tr><td><code>approve_unpause_set</code></td><td><code>set address</code></td><td>Set of addresses that approve unpausing the contract.</td></tr><tr><td><code>_state</code></td><td><code>nat</code></td><td><ul><li><code>O</code> : Starting</li><li><code>1</code> : Running</li><li><code>2</code> : Paused</li></ul></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_31ik" id="api">API<a aria-hidden="true" class="hash-link" href="#api" title="Direct link to heading">â€‹</a></h2><table><thead><tr><th>Entrypoint</th><th>Called by</th><th>Argument Michelson type</th><th>Argument</th><th>Desc.</th></tr></thead><tbody><tr><td><code>declare_ownership</code></td><td>Owner</td><td><code>address</code></td><td>Candidate address for new owner.</td><td></td></tr><tr><td><code>accept_ownership</code></td><td>Owner candidate</td><td><code>address</code></td><td></td><td>Owner is now caller.</td></tr><tr><td><code>set_metadata_uri</code></td><td>Owner</td><td><code>bytes</code></td><td>metadata</td><td>See <a href="https://gitlab.com/tezos/tzip/-/blob/master/proposals/tzip-16/tzip-16.md" target="_blank" rel="noopener noreferrer">TZIP-16</a>.</td></tr><tr><td><code>pause</code></td><td>Owner</td><td></td><td></td><td></td></tr><tr><td><code>approve_unpause</code></td><td>Manager</td><td></td><td></td><td></td></tr><tr><td><code>unpause</code></td><td><em>any</em></td><td></td><td></td><td></td></tr><tr><td><code>control</code></td><td>Owner</td><td><code>pair address bool</code></td><td><ul><li>manager address</li><li><code>True</code> to add, <code>False</code> to remove</li></ul></td><td></td></tr><tr><td><code>run</code></td><td>Owner</td><td></td><td></td><td>Transfers ownership to contract and set state to <code>Running</code></td></tr><tr><td><code>require</code></td><td>Owner</td><td><code>nat</code></td><td>new <code>required</code> value</td><td></td></tr><tr><td><code>set_duration</code></td><td>Owner</td><td><code>pair nat nat</code></td><td><ul><li>minimum validity duration</li><li>maximum validity duration</li></ul></td><td></td></tr><tr><td><code>propose</code></td><td>Manager</td><td><code>pair (lambda Unit (list operation)) (pair nat bool))</code></td><td><ul><li>lambda value for operations</li><li>validity duration</li><li>approved by calling manager</li></ul></td><td></td></tr><tr><td><code>approve</code></td><td>Manager</td><td><code>nat</code></td><td>proposal id</td><td></td></tr><tr><td><code>execute</code></td><td><em>any</em></td><td><code>nat</code></td><td>proposal id</td><td></td></tr><tr><td><code>propose_feeless</code></td><td>Manager</td><td><code>pair (lambda Unit (list operation)) (pair nat (pair bool (pair signature key))))</code></td><td><ul><li>lambda value for operations</li><li>validity duration</li><li>approved by calling manager</li><li>data signed by manager</li><li>manager&#x27;s public key</li></ul></td><td></td></tr><tr><td><code>approve_feeless</code></td><td>Manager</td><td><code>pair nat (pair signature key)</code></td><td><ul><li>proposal id</li><li>data signed by manager</li><li>manager&#x27;s public key</li></ul></td><td></td></tr><tr><td><code>get_manager_counter</code></td><td><em>any</em></td><td><code>address</code></td><td>manager address</td><td>view (TZIP4) to get the counter of a manager</td></tr><tr><td><code>get_approvals</code></td><td><em>any</em></td><td><code>nat</code></td><td>proposal id</td><td>view (TZIP4) to get the set of managers that approved the proposal</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_31ik" id="example-usage-scenario">Example usage scenario<a aria-hidden="true" class="hash-link" href="#example-usage-scenario" title="Direct link to heading">â€‹</a></h2><p>The Usage scenario presented here has an owner and three managers:</p><ul><li>Contract is deployed with parameters:<ul><li>owner: (an address)</li><li>required: <code>1</code></li><li>min_duration: <code>3600</code> (one hour)</li><li>max_duration: <code>15552000</code> (180 days)</li></ul></li><li>Owner calls <code>control</code> to add manager 1</li><li>Owner calls <code>control</code> to add manager 2</li><li>Owner calls <code>control</code> to add manager 3</li><li>Owner calls <code>require</code> to set required number of approvals to <code>2</code></li><li>Owner calls <code>run</code>; it transfers the contract ownership to managers and sets the contract state to <code>Running</code></li><li>Manager 1 calls <code>propose</code> to propose an action (for example call another contract)</li><li>Manager 2 calls <code>approve</code> to approve it (with proposal id <code>0</code>)</li><li>Manager 3 calls <code>approve</code> to approve it (with proposal id <code>0</code>)</li><li>Owner calls <code>execute</code> with proposal id <code>0</code> to execute the proposed action</li><li>Manager 2 calls <code>propose</code> to pause the contract</li><li>Manager 1 calls <code>approve</code> (with proposal id <code>1</code>)</li><li>Owner calls <code>execute</code> with proposal id <code>1</code>; as a result contract is paused</li><li>Manager 3 calls <code>approve_unpause</code></li><li>Manager 2 calls <code>approve_unpause</code></li><li>Owner calls <code>unpause</code></li><li>...</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="code">Code<a aria-hidden="true" class="hash-link" href="#code" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * Generic multisig contract</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">archetype multisig(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  owner        : address,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  required     : nat,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  max_duration : duration,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  min_duration : duration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Errors</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">constant EXPIRED_PROPOSAL    : string = &quot;EXPIRED_PROPOSAL&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">constant NOT_APPROVED        : string = &quot;NOT_APPROVED&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">constant INVALID_SIGNATURE   : string = &quot;INVALID_SIGNATURE&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">constant WRONG_DURATION      : string = &quot;WRONG_DURATION&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">constant CONTRACT_PAUSED     : string = &quot;CONTRACT_PAUSED&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">constant CONTRACT_NOT_PAUSED : string = &quot;CONTRACT_NOT_PAUSED&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Assets</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable id_count : nat = 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">asset manager {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  addr    : address;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  counter : nat = 0  // protects from double-spending attack</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">asset pending to big_map {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  id         : nat;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  expiration : date;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  approvals  : set&lt;address&gt;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  actions    : lambda&lt;unit, list&lt;operation&gt;&gt;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// States</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">states =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Starting initial</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Paused</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Owner role transfer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable owner_candidate : option&lt;address&gt; = none</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry declare_ownership(candidate : address) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by owner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    owner_candidate := some(candidate);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry claim_ownership() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by opt_get(owner_candidate)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    owner := opt_get(owner_candidate);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    owner_candidate := none</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Metadata</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry set_metadata_uri(idata : bytes) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by owner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    metadata := put(metadata, &quot;&quot;, idata)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Contract execution pause/resume</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">transition pause() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by owner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  from Running to Paused</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable approve_unpause_set : set&lt;address&gt; = []</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry approve_unpause () {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by manager</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Paused</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    approve_unpause_set.add(caller)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">transition unpause() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  from Paused to Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  when { approve_unpause_set.length() &gt;= required }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  with effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    approve_unpause_set := []</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Control entry to add / remove a manager</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// May be called in Starting or Running states</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry control(maddr : address, allowed : bool) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by owner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  //state is Starting or Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r4 : allowed &lt;&gt; manager.contains(maddr);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if allowed then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      manager.add({ addr = maddr })</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      manager.remove(maddr)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Transition to Running state</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// owner becomes selfaddress</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">transition run() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by owner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r0 : manager.count() &gt; required</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  from Starting to Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  with effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    owner := selfaddress</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Set parameters in Running state</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry %require(new_required : nat) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by owner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r7 : 0 &lt; new_required &lt; manager.count()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required := new_required</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry set_duration(min : duration, max : duration) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by owner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    min_duration := min;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    max_duration := max;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// propose, approve, execute</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry propose(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  actions_to_exec : lambda&lt;unit, list&lt;operation&gt;&gt;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  validity : duration,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  approved_by_caller : bool) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by manager</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r3 : min_duration &lt;= validity &lt;= max_duration otherwise WRONG_DURATION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    var init_approvals : set&lt;address&gt; = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if approved_by_caller then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      init_approvals.add(caller);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pending.add({</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      id_count;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      (now + validity);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      init_approvals;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      actions_to_exec</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    id_count += 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry approve(proposal_id : nat) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by manager</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if pending[proposal_id].expiration &lt; now then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      pending.remove(proposal_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      pending[proposal_id].approvals.add(caller)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry execute(proposal_id : nat) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r1 : pending[proposal_id].expiration &gt;= now otherwise EXPIRED_PROPOSAL;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r2 : length(pending[proposal_id].approvals) &gt;= required otherwise NOT_APPROVED</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    operations := exec_lambda(pending[proposal_id].actions, Unit);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pending.remove(proposal_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Fee-less process</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry propose_feeless(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  actions_to_exec : lambda&lt;unit, list&lt;operation&gt;&gt;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  validity : duration,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  approved_by_caller : bool,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  manager_key : key,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  sig : signature) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r8 : min_duration &lt;= validity &lt;= max_duration otherwise WRONG_DURATION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    var pkh = key_address(manager_key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    dorequire(check_signature(manager_key, sig, pack((pkh, manager[pkh].counter, &quot;propose&quot;, actions_to_exec, expiration_duration))), INVALID_SIGNATURE);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    var init_approvals : set&lt;address&gt; = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if approved_by_caller then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      init_approvals.add(caller);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pending.add({</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      id_count;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      (now + validity);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      init_approvals;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      actions_to_exec</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    id_count += 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry approve_feeless(proposal_id : nat, manager_key : key, sig : signature) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Running</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    var pkh = key_address(manager_key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    dorequire(check_signature(manager_key, sig, pack((pkh, manager[pkh].counter, &quot;approve&quot;, proposal_id))), INVALID_SIGNATURE);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    manager[pkh].counter += 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if pending[proposal_id].expiration &lt; now then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      pending.remove(proposal_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      pending[proposal_id].approvals.add(pkh)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Getters (aka TZIP4 view)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">getter get_manager_counter(pkh : address) : nat {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  return (if manager.contains(pkh) then manager[pkh].counter else 0)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">getter get_approvals(proposal_id : nat) : set&lt;address&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  var empty : set&lt;address&gt; = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  return (if pending.contains(proposal_id) then pending[proposal_id].approvals else empty)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/edukera/completium-landing/tree/master/docs/templates/template17.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/templates/healthcare"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Health care</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/templates/raffle"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Raffle<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#propose" class="table-of-contents__link toc-highlight">Propose</a><ul><li><a href="#calling-one-entrypoint" class="table-of-contents__link toc-highlight">Calling one entrypoint</a></li><li><a href="#michelson-types-and-values" class="table-of-contents__link toc-highlight">Michelson types and values</a></li></ul></li><li><a href="#state-machine" class="table-of-contents__link toc-highlight">State Machine</a><ul><li><a href="#transitions" class="table-of-contents__link toc-highlight">Transitions</a></li></ul></li><li><a href="#number-of-required-managers" class="table-of-contents__link toc-highlight">Number of required managers</a></li><li><a href="#feeless" class="table-of-contents__link toc-highlight">Feeless</a><ul><li><a href="#data-to-sign" class="table-of-contents__link toc-highlight">Data to sign</a></li></ul></li><li><a href="#storage" class="table-of-contents__link toc-highlight">Storage</a></li><li><a href="#api" class="table-of-contents__link toc-highlight">API</a></li><li><a href="#example-usage-scenario" class="table-of-contents__link toc-highlight">Example usage scenario</a></li><li><a href="#code" class="table-of-contents__link toc-highlight">Code</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/dapp-first">First Dapp</a></li><li class="footer__item"><a class="footer__link-item" href="/dapps">DApps</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/contract">Smart Contract</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/templates">Contract Templates</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/verification">Formal Verification</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/cli">CLI</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/dapp-tools/">Technical Stack</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://archetype-lang.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Archetype</a></li><li class="footer__item"><a href="https://www.edukera.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Edukera</a></li><li class="footer__item"><a href="https://github.com/edukera/completium-landing" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Edukera, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.db40fbb4.js"></script>
<script src="/assets/js/main.8bf3c954.js"></script>
</body>
</html>