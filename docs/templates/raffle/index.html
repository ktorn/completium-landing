<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Completium RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Completium Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><title data-react-helmet="true">Raffle | Completium</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/templates/raffle"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Raffle | Completium"><meta data-react-helmet="true" name="description" content="A raffle is a gambling game, where players buy tickets; a winning ticket is randomly picked and its owner gets the jackpot prize."><meta data-react-helmet="true" property="og:description" content="A raffle is a gambling game, where players buy tickets; a winning ticket is randomly picked and its owner gets the jackpot prize."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/templates/raffle"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/templates/raffle" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/templates/raffle" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.d284df69.css">
<link rel="preload" href="/assets/js/runtime~main.a8086ee3.js" as="script">
<link rel="preload" href="/assets/js/main.40829e0e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div></a><a class="navbar__item navbar__link" href="/docs/dapp-first">First DApp</a><a class="navbar__item navbar__link" href="/dapps">DApps</a><a class="navbar__item navbar__link" href="/docs/contract">Smart Contract</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/templates">Contract Templates</a><a class="navbar__item navbar__link" href="/docs/verification">Formal Verification</a><a class="navbar__item navbar__link" href="/docs/cli">CLI</a><a class="navbar__item navbar__link" href="/docs/dapp-tools">Technical stack</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/edukera/completium-landing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/templates">Presentation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/docs/templates/fa12">Fungible Token</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/docs/templates/nft">Non-Fungible Token</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/docs/templates/zcb">DeFi</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/docs/templates/escrow">Payment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_2fq0" href="/docs/templates/multisig">Governance</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/multisig">Multisig</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/templates/raffle">Raffle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/ideabox">Idea box</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/competition">Competition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/auction">Auction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/templates/a2">A 2</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Raffle</h1></header><p>A raffle is a gambling game, where players buy tickets; a winning ticket is <em>randomly</em> picked and its owner gets the jackpot prize.</p><p>The <a href="https://tezos.b9lab.com/michelson" target="_blank" rel="noopener noreferrer">Michelson</a> language does <strong>not</strong> provide an instruction to generate a random number. We can&#x27;t use the current date (value of <code>now</code>) as a source of randomness either. Indeed, bakers have some control on this value for the blocks they produce, and could therefore influence the result.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>The source code of the raffle contract and the orresponding test scenario are available in this <a href="https://gitlab.com/completium/archetype-raffle" target="_blank" rel="noopener noreferrer">repository</a>.</p></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="picking-the-winning-ticket">Picking the winning ticket<a aria-hidden="true" class="hash-link" href="#picking-the-winning-ticket" title="Direct link to heading">​</a></h2><p>The winning ticket <em>id</em> is obtained as the remainder of the euclidean division of an arbitraly large number, called here the <em>raffle key</em>, by the number of ticket buyers, called here <em>players</em>. For example, if the raffle key is 2022, and the number of raffle players is 87, then the winning ticket id is 21 (typically the 21st ticket).</p><p>The constraint is that this raffle key must not be known by anyone, nor the players or even the admin. Indeed if someone knows in advance the raffle key, it is then possible to influence the outcome of the game by buying tickets until one of them is the winning one (there is only one ticket per address, but someone can have several addresses). As a consequence:</p><ul><li>the <em>raffle key</em> cannot be simply stored in the contract.</li><li>the <em>raffle key</em> cannot be a secret that only the admin knows (for the reason above), and that the admin would pass to the contract when it is time to announce the winner. Indeed, the admin could disappear, and no winner would ever be announced.</li></ul><p>For the admin not to be the only one to know the key, each player must possess a part of the key (called here <em>partial key</em>), such that the raffle key is the sum of each player&#x27;s partial key. For the player&#x27;s partial key not to be known by the other players, it must be <em>encrpypted</em> by the player. When it comes to selecting the winning ticket, the user is required to <em>reveal</em> its key for the contract to compute the raffle key.</p><p>Moreover, the contract offers the possiblity for anyone to reveal a player&#x27;s key. This feature may be required when the reveal operation is critical to the process: for example in a voting process, it is important to take all votes into account, even votes from users who didn&#x27;t/couldn&#x27;t reveal their key. A reward is sent to an account that reveals a key.</p><p>The <a href="https://tezos.gitlab.io/alpha/timelock.html?highlight=timelock" target="_blank" rel="noopener noreferrer">timelock</a> encryption feature of the Michelson <code>chest</code> data type provides the required property: a <em>timelocked</em> value is encrypted strongly enough that even the most powerful computer will take more than a certain amount of time to crack it, but weakly enough that given a bit more time, any decent computer will manage to crack it. That is to say that, beyond a certain amount of time, the value may be considered public.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="chest-value">Chest value<a aria-hidden="true" class="hash-link" href="#chest-value" title="Direct link to heading">​</a></h2><p>In the <a href="https://gitlab.com/completium/archetype-raffle/-/blob/main/tests/00-test.js" target="_blank" rel="noopener noreferrer">raffle test example</a>, the <em>chest time</em> parameter imposed by the contract is <code>10000000</code>.</p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Note that it&#x27;s probably <em>not</em> a decent <em>chest time</em> value since it takes only 20s to break on a standard computer ...</p></div></div><p>Player Alice&#x27;s partial key is <code>123456</code> and Player Jack&#x27;s is <code>234567</code>.</p><p>To get the timelocked value, the value is first packed (turned into bytes) with the following tezos client command <code>hash data</code>:</p><div class="codeBlockContainer_K1bP language-bash"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ tezos-client -E https://hangzhounet.smartpy.io </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">hash</span><span class="token plain"> data </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;123456&#x27;</span><span class="token plain"> of </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">type</span><span class="token plain"> nat</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Warning:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 This is NOT the Tezos Mainnet.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           Do NOT use your fundraiser keys on this network.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Raw packed data: 0x050080890f</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We then use the Completium <a href="https://github.com/completium/timelock-utils" target="_blank" rel="noopener noreferrer">timelock-utils</a> tool to timelock the packed data:</p><div class="codeBlockContainer_K1bP language-bash"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ timelock-utils --lock --data 050080890f --time </span><span class="token number">100000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;chest&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;c5ecdde89eb8c1e7aaeb85abb8f5e5cef3b4fa80c4aee2fccbf0a78ce0debaa5e9ddede3ddfbd9abdea28cc7dc99e6d3a9baf3cbae9adaaabc89cbc39e97e2c7a6cba99197d19ba09ddfd181afc997ffbcc5acb2d29ecbb698c2cacbdd83d1b4ced0bffe9cd78295b3fba4d9f9d5f4d4ec9ad3c7e1a8eeb9dba5cbd8a2dbf29af8e4a4c1e4b1edacf98fccefaef9fea4f0bacdd38ecbfe81c3f9839b9e9ab8fbf5f1eabac48a9f8ca7c588eefe94d1f18bd9bcee9aecde8dd285cf9098f4e1a7eec787f3a0e0ff9cd0ce8ec5a2a4e5ecb08fce899eb5baa397fabf90de9397cebc81bbdfb386e6b4da9fd8fdd19ed9f8d684c782b0aacfeebae4f6e7d1c5c1e6a093c68081cf83b991b4ecd7b38aee92deddcad79eb9abe0a0a0c6b5909dc58495f69445fff5ae9cefe8b8beb2fb86ccf5c9ad91989bdad8a3cfbedaffa2de8bf19dc6ac8cbc8a9584fa9f85f9ba958fc6bbc09ac8e7d5f0fdb98b86c1c7d59ad7c6dfc2d2cefaf5d9db909bf0e3acd3ccc792bc9bccbab4a4febda9b685dbc39ea2a4a7b69990d3abd8b9b3d7dbc581b984f3e08a98f7f7f0e697cc8dfd88edc8c3ca8dc3b2a9ccf6cdd6d0efcc848bc8ead5858bbabfcfc1c8ecea84fd9b96a5e4eabb8c918dafe6f78d83e8e1c2e5f8ee88a4ee8dcaeeafffebfcbbfda1e9eb86c582f2eedd9299cbc0a7fce083ced8c8ddb0e7eaacb696c1fccdadcdc8e3c6f7b9de84eece9bb7919094fef4fdf6efd8b1ba8bbecb9380add4f59ddbf9a19f95facc84e9d0a99bfa93f1fcc3a0fbde9b9ce0c7e8dec6e8d1dfa7dda6f490bb9580abfdbcc0e202e5ff731c3c17d080ee430edd30979a47aa653656e11e593800000015c2ca2a23b732a72932611618ad9ea324986377591e&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;key&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;a0aceddfb3c9fbe1b8c382c7d5a7dedbe2e5adf9edcfc3e9d084caa6aeb9818ff1e985cb9efe8fa089ceeaa0f5d0bcb583e2f29196f2d3908fffffdcda868faffcb78fb697e7eaf3e7dca9d4b5dda2c3e4f8adf8abf484ecae85f7d6e0f2d28cb69af1d7b19082e8d8d7ba96e7e1e0bb8ac9b9fcf0a9e5b7c1a499c4faf4c8a3a9c8e4d09aa780eac6cee1b78a97a3e983abf9a5f1e8d2a2a2b5e3bcb8c4effeb7a3a68a85a497cd91c9a2c096c3f596deb8d1aca3a5aff28effb8cfc9c7ced892e3a7c09deeb8c8ec9387a3b384b5c8bccaafc7a9a2c1cfd8c7becfd7d6828a9af8f4988fe4ead3b59ecfb8ff8cabf8be90d4c8bdbddfce9cd7c2bb81edc4b7ad80a59a978f8c9debe7aaf08cf0c588f3eaade6b9f4e4e6edf1ed9c9988e48d9ba0aa8f01d18bac92b886db9dd798b5f6fdc891a28da2c4c48da1918897a2b7c2dfa0b78ab8e291b68fb1a2bfa5e8b88e9cabb0b5b0feabcffc9cfeee888ac4afeed9dc8bf5a4eaa9ae89a3838cf6cfd4f8acff8fa7aef7a9889fbbc7d8f6dde4edf3e58096e580e299e5b082b9cf85f3fe8ac6c0998eb1bcbab9bfb8fba39faea7bce0f6fed9ea86dfdad58cf7cbc7fcc4ecf7e2e898d3b19582e38c8092b7e4a0cddc83eb8bc38d91fefed6be869496b8e4fc99d5fae5c6a2b2dcabe2a4ea85b68b87b182d7e8cac29fe0b9efd6d0eb999ffa98aaaf9bf09fe7c4b39d81db97e4e7bbaef0e3bfedd69d9089bc8d91b292afa6c8b389fc9fb7aaa8decab6d9b493a6eafaa5baffe8fb85f2d483ecd1f2d1e58f938df9d8d5e385fe96c5f58ae1e0b09bf2b3c2931f&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The timelock encryption generates a chest value, and the key to unlock it.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="raffle-storage">Raffle storage<a aria-hidden="true" class="hash-link" href="#raffle-storage" title="Direct link to heading">​</a></h2><p>The contract is originated with the following parameters:</p><ul><li><code>owner</code> is the address of the contract administrator</li><li><code>jackpot</code> is the prize in tez</li><li><code>ticket_price</code> speaks for itslef</li></ul><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">archetype raffle(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  owner        : address,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  jackpot      : tez,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ticket_price : tez)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="state">State<a aria-hidden="true" class="hash-link" href="#state" title="Direct link to heading">​</a></h3><p>The contract holds:</p><ul><li>a state with 3 possible values:<ul><li><code>Created</code> is the initial state during which tickets cannot be bought yet</li><li><code>Initialised</code> is the state when the administrator initialises the raffle</li><li><code>Transferred</code> is the state when prize has been transferred to the winner</li></ul></li></ul><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">states =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Created initial</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Initialised</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Transferred</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>the open date beyond which tickets can be bought, initialized to <code>none</code>:</li><li>the date beyond which tickets cannot be bought, initialized to <code>none</code>:</li><li>the date beyond which player&#x27;s partial key cannot be revealed, initialized to <code>none</code>:</li></ul><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable open_buy     : option&lt;date&gt; = none</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable close_buy    : option&lt;date&gt; = none</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable close_reveal : option&lt;date&gt; = none</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The schema below illustrates the periods defined by these dates, and the contract&#x27;s states:</p><img src="/img/schema.light.svg" alt="Raffle schema" class="themedImage_1VuW themedImage--light_3UqQ" width="80%"><img src="/img/schema.dark.svg" alt="Raffle schema" class="themedImage_1VuW themedImage--dark_hz6m" width="80%"><h3 class="anchor anchorWithStickyNavbar_31ik" id="other">Other<a aria-hidden="true" class="hash-link" href="#other" title="Direct link to heading">​</a></h3><p>The contract also holds:</p><ul><li>the reveal fee, initialized to <code>none</code>:</li></ul><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable reveal_fee : option&lt;rational&gt; = none</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>the time used to generate the timelocked value of the raffle key (it should be high enough to be compliant with the close date), initialized to <code>none</code>:</li></ul><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable chest_time : option&lt;nat&gt; = none</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>a collection that will contain the addresses of all players and their raffle key:</li></ul><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">asset player {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  id                 : address;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  locked_raffle_key  : chest;        (* partial key *)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  revealed           : bool = false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>the raffle key, updated when a player&#x27;s partial key is revealed:</li></ul><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable raffle_key  : nat = 0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="entrypoints">Entrypoints<a aria-hidden="true" class="hash-link" href="#entrypoints" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="initialise"><code>initialise</code><a aria-hidden="true" class="hash-link" href="#initialise" title="Direct link to heading">​</a></h3><p>The <code>initialise</code> entrypoint is called by the contract admin (called &quot;<em>owner</em>&quot;) to set the main raffle parameters:</p><ul><li><em>open buy</em> is the date beyond which players can buy ticket</li><li><em>close buy</em> is the date beyond which players cannot buy ticket</li><li><em>close reveal</em> is the date beyond which players cannot reveal key</li><li><em>chest time</em> is the difficulty to break players&#x27; partial raffle key encryption</li><li><em>reveal fee</em> the pourcentage of ticket price transferred when revealing a player&#x27;s raffle key</li></ul><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Currently you may count from a chest time of 500<!-- --> <!-- -->000 per second on a standard computer, to a chest time value of 500<!-- --> <!-- -->000<!-- --> <!-- -->000 per second on dedicated hardware.</p></div></div><p>It requires that:</p><ul><li>the reveal period duration be greater or equal to the buy period duration</li><li>th reveal fee be equal to or less than 1</li><li>the transferred amount of tez be equal to the <code>jackpot</code> storage value</li></ul><p>It transitions from <code>Created</code> state to <code>Initialised</code>, and sets the raffle parameters.</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">transition initialise(ob : date, cb : date, cr : date, t : nat, rf : rational) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  called by owner</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r0 : now &lt;= ob &lt; cb and cb - ob &lt;= cr - cb otherwise &quot;INVALID_OPEN_CLOSE_BUY_REVEAL&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r1 : rf &lt;= 1                               otherwise &quot;INVALID_REVEAL_FEE&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r2 : transferred = jackpot                 otherwise &quot;INVALID_AMOUNT&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  from Created to Initialised</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  with effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    open_buy     := some(ob);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    close_buy    := some(cb);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    close_reveal := some(cr);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    chest_time   := some(t);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    reveal_fee   := some(rf)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="buy"><code>buy</code><a aria-hidden="true" class="hash-link" href="#buy" title="Direct link to heading">​</a></h3><p>The <code>buy</code> entrypoint may be called by anyone to buy a ticket. The player must transfer the encrypted value of the partial raffle key, so that the partial key value may be potentially publically known when it comes to declaring the winner ticket.</p><p>It requires that:</p><ul><li>the contract be in <code>Initialised</code> state</li><li>the transferred amount of tez be equal to the ticket price</li><li>the close date not be reached</li></ul><p>It records the caller&#x27;s address in the <code>player</code> collection.</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry buy (lrk : chest) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Initialised</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r3 : transferred = ticket_price                     otherwise &quot;INVALID_TICKET_PRICE&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r4 : opt_get(open_buy) &lt; now &lt; opt_get(close_buy)   otherwise &quot;BUY_CLOSED&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect { player.add({ id = caller; locked_raffle_key = lrk }) }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Note that the <code>add</code> method <em>fails</em> with <code>(Pair &quot;KeyExists&quot; &quot;player&quot;)</code> if the caller is already in the collection.</p></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="reveal"><code>reveal</code><a aria-hidden="true" class="hash-link" href="#reveal" title="Direct link to heading">​</a></h3><p>The <code>reveal</code> entry point may be called by anyone to reveal a player&#x27;s <em>partial</em> key and contribute to the computation of the raffle key. The caller receives a percentage of the ticket price as a reward.</p><p>It requires that:</p><ul><li>the contract be in <code>Initialised</code> state</li><li>the close date has been reached</li></ul><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry reveal(addr : address, k : chest_key) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  state is Initialised</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r5 : opt_get(close_buy) &lt; now &lt; opt_get(close_reveal) otherwise &quot;REVEAL_CLOSED&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r6 : not player[addr].revealed                        otherwise &quot;PLAYER_ALREADY_REVEALED&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    match open_chest(k, player[addr].locked_raffle_key, opt_get(chest_time)) with</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    | left (unlocked) -&gt; raffle_key += opt_get(unpack&lt;nat&gt;(unlocked))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    | right(error)    -&gt; fail(&quot;INVALID_TIMELOCK&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    player[addr].revealed := true;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    transfer (opt_get(reveal_fee) * ticket_price) to caller;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="transfer"><code>transfer</code><a aria-hidden="true" class="hash-link" href="#transfer" title="Direct link to heading">​</a></h3><p>When the reveal period is over, anyone can call the <code>transfer</code> entrypoint to transfer the jackpot to the the winning ticket; not revealed players are ignored. It transitions to <code>Transferred</code> state:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">transition %transfer() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  require {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    r7: opt_get(close_reveal) &lt; now otherwise &quot;TRANSFER_CLOSED&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  from Initialised to Transferred</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  with effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    player.removeif(not the.revealed);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    transfer balance to player.nth(raffle_key % player.count());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/edukera/completium-landing/tree/master/docs/templates/template18.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/templates/multisig"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->Multisig</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/templates/ideabox"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Idea box<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#picking-the-winning-ticket" class="table-of-contents__link toc-highlight">Picking the winning ticket</a></li><li><a href="#chest-value" class="table-of-contents__link toc-highlight">Chest value</a></li><li><a href="#raffle-storage" class="table-of-contents__link toc-highlight">Raffle storage</a><ul><li><a href="#state" class="table-of-contents__link toc-highlight">State</a></li><li><a href="#other" class="table-of-contents__link toc-highlight">Other</a></li></ul></li><li><a href="#entrypoints" class="table-of-contents__link toc-highlight">Entrypoints</a><ul><li><a href="#initialise" class="table-of-contents__link toc-highlight"><code>initialise</code></a></li><li><a href="#buy" class="table-of-contents__link toc-highlight"><code>buy</code></a></li><li><a href="#reveal" class="table-of-contents__link toc-highlight"><code>reveal</code></a></li><li><a href="#transfer" class="table-of-contents__link toc-highlight"><code>transfer</code></a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/dapp-first">First Dapp</a></li><li class="footer__item"><a class="footer__link-item" href="/dapps">DApps</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/contract">Smart Contract</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/templates">Contract Templates</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/verification">Formal Verification</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/cli">CLI</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/dapp-tools/">Technical Stack</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://archetype-lang.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Archetype</a></li><li class="footer__item"><a href="https://www.edukera.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Edukera</a></li><li class="footer__item"><a href="https://github.com/edukera/completium-landing" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Edukera, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a8086ee3.js"></script>
<script src="/assets/js/main.40829e0e.js"></script>
</body>
</html>