<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Completium RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Completium Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><title data-react-helmet="true">Invariant | Completium</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/verification/invariant"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Invariant | Completium"><meta data-react-helmet="true" name="description" content="An invariant is a property of the contract state (storage, balance) that is always true, regardless of the history of calls to the contract."><meta data-react-helmet="true" property="og:description" content="An invariant is a property of the contract state (storage, balance) that is always true, regardless of the history of calls to the contract."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/verification/invariant"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/verification/invariant" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/verification/invariant" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.d284df69.css">
<link rel="preload" href="/assets/js/runtime~main.fccaef66.js" as="script">
<link rel="preload" href="/assets/js/main.a97f764e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div></a><a class="navbar__item navbar__link" href="/docs/dapp-first">First DApp</a><a class="navbar__item navbar__link" href="/dapps">DApps</a><a class="navbar__item navbar__link" href="/docs/contract">Smart Contract</a><a class="navbar__item navbar__link" href="/docs/templates">Contract Templates</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/verification">Formal Verification</a><a class="navbar__item navbar__link" href="/docs/cli">CLI</a><a class="navbar__item navbar__link" href="/docs/dapp-tools">Technical stack</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/edukera/completium-landing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/verification">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/verification/tools">Tools</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_2fq0" href="/docs/verification/specification">Specification Guidelines</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/verification/specification">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/verification/postcondition">Postcondition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/verification/fail">Failure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/verification/invariant">Invariant</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/verification/conclusion">Conclusion</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Invariant</h1></header><p>An invariant is a property of the contract state (storage, balance) that is always true, regardless of the history of calls to the contract.</p><p>If there are <em>E</em> entrypoints in the contract, <a href="http://why3.lri.fr/" target="_blank" rel="noopener noreferrer">Why3</a> will automatically generate <em>E+1</em> proof obligations out of one invariant:</p><ul><li>one for the initial storage value: the invariant is true at the contract origination</li><li>one per entrypoint to prove the invariant as a postcondition, assuming the property holds before entrypoint execution</li></ul><p>There is no systemic method to establish contract invariants. You need to figure them out case by case by aksing &quot;what do entrypoints preserve?&quot; or &quot;which relations hold between storage variables?&quot; Below is a presentation of two principles you can use to figure out invariants.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="conservation">Conservation<a aria-hidden="true" class="hash-link" href="#conservation" title="Direct link to heading">â€‹</a></h2><p>In these examples, the invariant comes from the fact that information is transfered by entrypoints from one place to the other in the contract storage. It is then possible to write a global conservation equation.</p><p>The invariant of the <a href="/docs/templates/fa12">FA 1.2</a> contract states that the total number of tokens is a constant. Indeed tokens are transferred from one account to the other, but the total number of tokens is conserved, no token is minted or lost:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">specification {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  i: ledger.sum(tokens) = totalsupply;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The invariant of the <a href="/docs/templates/ideabox">Idea Box</a> contract is a conservation equation between maximum number of votes per voter, the actual number of votes received by ideas, and the remaining number of votes per voter.</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">specification {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  i1 : maxvotes * voter.count() = idea.sum(nbvotes) + voter.sum(remaining)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note that the invariant is global and that it is not possible in this case to state the conservation principle at the voter level, because the contract does not store the information of which voter voted for which idea.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="accumulation">Accumulation<a aria-hidden="true" class="hash-link" href="#accumulation" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="example">Example<a aria-hidden="true" class="hash-link" href="#example" title="Direct link to heading">â€‹</a></h3><p>In this example, the invariant comes from the fact that an information is the accumulation of other information as a result of calls to entrypoints. It is then possible to write an accumulation equation.</p><p>Say the contract is selling non fungible tokens, and each time a token is sold, the balance is increased by a percent of the token fixed price, the fee. Say the information is stored in an asset collection <code>ledger</code> defined as:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">variable fee : rational = 0.003</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">asset ledger {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  id        : string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  price     : tez,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  sellcount : nat = 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>sellcount</code> is the number of times the token has been sold.</p><p>The contract invariant is then the formula for the balance:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">balance = fee * ledger.sum(sellcount * price)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="shadow-variables">Shadow variables<a aria-hidden="true" class="hash-link" href="#shadow-variables" title="Direct link to heading">â€‹</a></h3><p>If an information is missing to express the invariant, it is possible to use <em>shadow variables</em>: they do not appear in the final contract storage or code, while they are available in specification.</p><p>Typically the <code>sellcount</code> field in the above example is a pure accumulation variable only used the invariant formula. It is then better not to have it as a real field and pay for its storage, and turn it into a shadow field.</p><p>The following shows how to declare <code>sellcount</code> as a shadow field:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">asset ledger {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  id        : string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  price     : tez</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} shadow {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  sellcount : int = 0;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Shadow variables cannot be used in entrypoints&#x27; effect. It can only be used in dedicated shadow effect sections. Shadow effects are virtually executed <em>after</em> the entrypoint section.</p><p>In this case, the <code>sell</code> entrypoint declares such a section to accumulate the number of times a card is sold:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry sell(i : string) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  specification {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    shadow effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ledger[i].sellcount += 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With shadow variables it is possible to accumulate what is necessary to formulate the invariant. In the Box Idea contract presented above, it would be possible to add an field in the <code>voter</code> asset that stores the sum of weights:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">asset voter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  addr        : address;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  remaining   : nat = maxvotes;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} shadow {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  totalweight : nat = 0;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>vote</code> entrypoint would have a shadow effect to store the idea&#x27;s id:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">entry vote(n : nat, weight : nat) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  specification {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    shadow effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      voter[caller].totalweight += weight</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  effect {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The invariant may then use this shadow information to express maximum vote conservation at voter&#x27;s level:</p><div class="codeBlockContainer_K1bP language-archetype"><div class="codeBlockContent_hGly archetype"><pre tabindex="0" class="prism-code language-archetype codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">forall v in voter,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  v.maxvotes = v.totalweight + v.remaining</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/edukera/completium-landing/tree/master/docs/verification/verification7.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/verification/fail"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Failure</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/verification/conclusion"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Conclusion<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#conservation" class="table-of-contents__link toc-highlight">Conservation</a></li><li><a href="#accumulation" class="table-of-contents__link toc-highlight">Accumulation</a><ul><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#shadow-variables" class="table-of-contents__link toc-highlight">Shadow variables</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/dapp-first">First Dapp</a></li><li class="footer__item"><a class="footer__link-item" href="/dapps">DApps</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/contract">Smart Contract</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/templates">Contract Templates</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/verification">Formal Verification</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/cli">CLI</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/dapp-tools/">Technical Stack</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://archetype-lang.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Archetype</a></li><li class="footer__item"><a href="https://www.edukera.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Edukera</a></li><li class="footer__item"><a href="https://github.com/edukera/completium-landing" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Edukera, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fccaef66.js"></script>
<script src="/assets/js/main.a97f764e.js"></script>
</body>
</html>