"use strict";(self.webpackChunkcompletium_landing=self.webpackChunkcompletium_landing||[]).push([[2575],{9688:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return p},metadata:function(){return c},toc:function(){return d},default:function(){return u}});var a=n(7462),o=n(3366),i=(n(7294),n(3905)),r=n(9960),s=["components"],l={id:"miles8",title:"Interactions with contract",sidebar_label:"Interactions",slug:"/dapp-miles/miles-tg-interactions"},p=void 0,c={unversionedId:"dapp-miles/miles8",id:"dapp-miles/miles8",title:"Interactions with contract",description:"This page presents how to implement the DApp's interactions with the smart contract.",source:"@site/docs/dapp-miles/miles8.md",sourceDirName:"dapp-miles",slug:"/dapp-miles/miles-tg-interactions",permalink:"/docs/dapp-miles/miles-tg-interactions",editUrl:"https://github.com/edukera/completium-landing/tree/master/docs/dapp-miles/miles8.md",tags:[],version:"current",frontMatter:{id:"miles8",title:"Interactions with contract",sidebar_label:"Interactions",slug:"/dapp-miles/miles-tg-interactions"},sidebar:"dapps",previous:{title:"Contract setup",permalink:"/docs/dapp-miles/miles-tg-contract"},next:{title:"Introduction",permalink:"/docs/dapp-iot"}},d=[{value:"Connect to wallet utilities",id:"connect-to-wallet-utilities",children:[],level:2},{value:"Read contract storage",id:"read-contract-storage",children:[],level:2},{value:"Call entry point",id:"call-entry-point",children:[],level:2}],m={toc:d};function u(e){var t=e.components,n=(0,o.Z)(e,s);return(0,i.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"This page presents how to implement the DApp's interactions with the smart contract."),(0,i.kt)("h2",{id:"connect-to-wallet-utilities"},"Connect to wallet utilities"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"src/dapp.js")," file defines the necessary utilities to connect the DApp to the blockchain via the Temple wallet:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"check whether wallet is connected"),(0,i.kt)("li",{parentName:"ul"},"get the Taquito's object"),(0,i.kt)("li",{parentName:"ul"},"...")),(0,i.kt)("p",null,"In order to make it available accross the React project, these methods are managed with a ",(0,i.kt)("a",{href:"https://www.npmjs.com/package/constate"},"Constate")," storage. Constate provides a local centralized storage for React project with minimum effort."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"dapp.js")," defines a node ",(0,i.kt)("inlineCode",{parentName:"p"},"DAppProvider")," that needs to be wrap the App node. The ",(0,i.kt)("em",{parentName:"p"},"FIX ME")," section is to be found line 53 in   ",(0,i.kt)("inlineCode",{parentName:"p"},"src/DApp.js")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function App() {\n  return (\n    ///////////////////////////////////////////////////////////////////////////\n    // FIX ME\n    // Wrap the App's body with <DAppProvider> tag/function in order to benefit\n    // from wallet's service as defined in dapp.js\n    ///////////////////////////////////////////////////////////////////////////\n    <React.Suspense fallback={null}>\n      <PageRouter />\n    </React.Suspense>\n  );\n}\n")),(0,i.kt)("p",null,"The code below shows how to declare the ",(0,i.kt)("inlineCode",{parentName:"p"},"DAppProvider")," so that it makes the Thanos utilities available to the DApp:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function App() {\n  return (\n    <DAppProvider appName={appName}>\n      <React.Suspense fallback={null}>\n        <PageRouter />\n      </React.Suspense>\n    </DAppProvider>\n  );\n}\n")),(0,i.kt)("p",null,"Copy-paste the code above."),(0,i.kt)("h2",{id:"read-contract-storage"},"Read contract storage"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Miles")," component defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"src/components/Miles.js")," displays the time before next expiration date. The first step defines a React ",(0,i.kt)("inlineCode",{parentName:"p"},"useEffect")," ",(0,i.kt)("a",{href:"https://reactjs.org/docs/hooks-reference.html#useeffect"},"hook")," to read the miles's data for the connected account:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const Miles = (props) => {\n\n  /////////////////////////////////////////////////////////////////////////////\n  // The 'account' variable retrieved from 'dapp.js' is the connected account\n  // address\n  /////////////////////////////////////////////////////////////////////////////\n  const account = useAccountPkh();\n  /////////////////////////////////////////////////////////////////////////////\n  // The 'tezos' variable retrieved from 'dapp.js' is used to interact with the\n  // blockchain\n  /////////////////////////////////////////////////////////////////////////////\n  const tezos = useTezos();\n\n  useEffect(() => {\n    ///////////////////////////////////////////////////////////////////////////\n    // FIX ME:\n    // the goal here is to read the contract storage to extract miles' info\n    // for the connected 'account' and invoke the 'props.handleMiles' function\n    // defined in App.js; it takes 2 arguments:\n    // * contract object itself\n    // * list of miles data { id; amount; expration } for the account 'address'\n    ///////////////////////////////////////////////////////////////////////////\n  }, [props.nbMiles]);\n\n  return (\n    <Container style={{ height: '300px'}}>\n    ...\n    </Container>);\n}\n")),(0,i.kt)("p",null,"The goal of the hook is to build an array of objects providing ",(0,i.kt)("em",{parentName:"p"},"for the current connected account"),":"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"miles' id"),(0,i.kt)("li",{parentName:"ul"},"amount of miles"),(0,i.kt)("li",{parentName:"ul"},"expiration date of the miles")),(0,i.kt)("p",null,"The role of the ",(0,i.kt)(r.Z,{to:"/docs/dapp-tools/taquito",mdxType:"Link"},"Taquito")," library is to retrieve the contract data and provide it as a plain javascript object that is straightforward to read."),(0,i.kt)("p",null,"Here the javascript object of the smart contract's storage provides the following members:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"owner")," is the list of miles' owners providing:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"address"),(0,i.kt)("li",{parentName:"ul"},"list of miles'ids"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"mile")," is the list of miles providing:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"miles id"),(0,i.kt)("li",{parentName:"ul"},"amount"),(0,i.kt)("li",{parentName:"ul"},"expiration")))),(0,i.kt)("p",null,"The code below tests if the connected account ",(0,i.kt)("inlineCode",{parentName:"p"},"account")," is present in the storage. If it exists, miles' data is retrieved in ",(0,i.kt)("inlineCode",{parentName:"p"},"mile")," member for each of the ",(0,i.kt)("inlineCode",{parentName:"p"},"account"),"'s miles'id:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"}," useEffect(() => {\n    tezos.wallet.at(contractAddress).then(contract => {\n      contract.storage().then(storage => {\n        var dappMiles = [];\n        if (storage.owner.has(account)) {\n          storage.owner.get(account).forEach(mid => {\n            var mile = storage.mile.get(mid);\n            dappMiles.push({\n              id         : mid,\n              amount     : mile.amount,\n              expiration : mile.expiration\n            });\n          });\n        }\n        props.handleMiles(contract, dappMiles);\n      })\n    });\n  }, [props.nbMiles]);\n")),(0,i.kt)("p",null,"Copy-paste the code above for the DApp to read the contract storage."),(0,i.kt)("p",null,"The Taquito's contract object is retrieved with the following code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"tezos.wallet.at(contractAddress).then(contract => {\n    ...\n});\n")),(0,i.kt)("p",null,"The Taquito's contract's storage object is retrieved with the following code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"contract.storage().then(storage => {\n    ...\n}\n")),(0,i.kt)("h2",{id:"call-entry-point"},"Call entry point"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"ProductButton")," component defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"/src/components/Products.js")," is the 'Get it' button at the bottom of the product item.\nWhen clicked, the ",(0,i.kt)("inlineCode",{parentName:"p"},"handleClick")," method is executed."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"function ProductButton(props) {\n\n  const handleClick = () => {\n    ///////////////////////////////////////////////////////////////////////////\n    // FIX ME\n    // The goal is to call the 'consume' contract's entry point. The number of\n    // miles to consume is 'props.nbmiles'.\n    // On the UI front, the snack bar should be opened whith 'props.openSnack()'\n    // while the transaction is confirmed, and closed when confirmed with\n    // 'props.closeSnack()'.\n    // The 'receipt()' method of the operation is used to know when the\n    // transaction is confirmed.\n    ///////////////////////////////////////////////////////////////////////////\n  }\n  return (\n      ...\n  );\n}\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"consume")," entry point must be invoked by the connected account; it takes one parameter that is the number of miles to subtract or delete."),(0,i.kt)("p",null,"The ",(0,i.kt)(r.Z,{to:"/docs/dapp-tools/taquito",mdxType:"Link"},"Taquito")," library provides methods named as the contract's entry points to make it very simple to call the contract. These methods/entry point take the same arguments as the contract's."),(0,i.kt)("p",null,"The code below calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"consume")," entry point:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const handleClick = () => {\n    props.contract.methods.consume(props.nbmiles).send().then(op => {\n      console.log(`waiting for ${op.opHash} to be confirmed`);\n      props.openSnack();\n      op.receipt().then(() => {\n        props.handleReceipt();\n      });\n    })\n}\n")),(0,i.kt)("p",null,"Copy-paste the code above to call the contract."),(0,i.kt)("p",null,"Note that calling the ",(0,i.kt)("inlineCode",{parentName:"p"},"consume")," entry point returns an ",(0,i.kt)("em",{parentName:"p"},"Operation")," object. This object provides the ",(0,i.kt)("inlineCode",{parentName:"p"},"receipt")," method which returns when the operation is confirmed."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"openSnack")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"closeSnack")," methods open and close (via ",(0,i.kt)("inlineCode",{parentName:"p"},"handleReceipt"),") the snack popup to inform the user that a confirmation is waited for."))}u.isMDXComponent=!0}}]);